# Validation Report: fitsio-pure

This report documents the validation of `fitsio-pure` against real-world astronomical FITS files.

## NASA Sample Files

| File | Status | Findings |
|------|--------|----------|
| `test0.fits` | PASS | Metadata and multi-extension image structure correctly parsed. |
| `tb.fits` | PASS | Binary table structure correctly parsed. |
| `NICMOSn4hk12010_mos.fits` | PASS | Handled 5 image extensions (SCI, ERR, DQ, SAMP, TIME) correctly. |
| `IUElwp25637mxlo.fits` | PASS | Binary table metadata for IUE spectrum correctly extracted. |
| `WFPC2u5780205r_c0fx.fits` | PASS | 3D data cube primary HDU and associated table correctly parsed. |
| `comp.fits` | PARTIAL | HDU identified as BINTABLE (correct at low level), but lacks high-level tiled compression support. |

## fitsrs Test Corpus

Validated against the [fitsrs](https://github.com/cds-astro/fitsrs) test corpus (38 files from NASA, CDS, and HiPS generators). To run locally:

```sh
curl -L -o /tmp/fits-rs-test-files.tar \
  "https://alasky.cds.unistra.fr/Aladin-Lite-test-files/fits-rs-test-files.tar"
mkdir -p reference/fitsrs-samples
tar xf /tmp/fits-rs-test-files.tar -C reference/fitsrs-samples/
cargo test --test fitsrs_samples -- --nocapture
```

**Result: 25 pass, 13 fail (66% pass rate)**

### Passing Files (25)

| Directory | File | HDUs |
|-----------|------|------|
| astrometry.net | `corr.fits` | Primary + BinTable(28 cols) |
| fits.gsfc.nasa.gov | `EUVE.fits` | Primary + 3 Image(16-bit) + 4 BinTable |
| fits.gsfc.nasa.gov | `FITS RICE_ONE.fits` | Primary + BinTable(compressed) |
| fits.gsfc.nasa.gov | `HST_FGS.fits` | Primary(32-bit, 89688x7) + AsciiTable |
| fits.gsfc.nasa.gov | `HST_FOC.fits` | Primary(-32, 1024x1024) + AsciiTable |
| fits.gsfc.nasa.gov | `HST_FOS.fits` | Primary(-32, 2064x2) + AsciiTable |
| fits.gsfc.nasa.gov | `HST_HRS.fits` | Primary(-32, 2000x4) + AsciiTable |
| fits.gsfc.nasa.gov | `HST_NICMOS.fits` | Primary + 5 Image extensions |
| fits.gsfc.nasa.gov | `HST_WFPC_II.fits` | Primary(-32, 200x200x4) + AsciiTable |
| fits.gsfc.nasa.gov | `HST_WFPC_II_bis.fits` | Primary(-32, 100x100) |
| fits.gsfc.nasa.gov | `IUE_LWP.fits` | Primary + BinTable(9 cols) |
| fits.gsfc.nasa.gov | `m13_gzip.fits` | Primary + BinTable(compressed) |
| fits.gsfc.nasa.gov | `m13_rice.fits` | Primary + BinTable(compressed) |
| fits.gsfc.nasa.gov | `m13real_rice.fits` | Primary + BinTable(3 cols, compressed) |
| hips2fits | `cutout-CDS_P_HST_PHAT_F475W.fits` | Primary(-32, 3000x3000) |
| hipsgen | `Npix208.fits` | Primary(-32, 64x64) |
| hipsgen | `Npix282.fits` | Primary(-32, 64x64) |
| misc | `EUC_MER_MOSAIC-VIS-FLAG_...fits` | Primary(32, 19200x19200) |
| misc | `P122_49.fits` | Primary(-64, 9108x9108) |
| misc | `bonn.fits` | Primary(-32, 300x300) |
| misc | `ngc5457K.fits` | Primary(-32, 2853x5706) |
| misc | `skv1678175163788.fits` | Primary(-32, 300x300) |
| vizier | `II_278_transit.fits` | Primary + BinTable(11 cols) |
| vizier | `NVSSJ235137-362632r.fits` | Primary(-32, 1024x1024x1x1) + BinTable |
| vizier | `VAR.358.R.fits` | Primary(-32, 51x51) |

### Failing Files (13)

| File | Error | Root Cause |
|------|-------|------------|
| `Astro_UIT.fits` | invalid FITS header | Non-block-aligned: 864810 bytes (mod 2880 = 810) |
| `Npix132.fits` | invalid FITS header | Non-block-aligned: 527168 bytes (mod 2880 = 128) |
| `Npix133.fits` | invalid FITS header | Non-block-aligned (same as Npix132) |
| `Npix134.fits` | invalid FITS header | Non-block-aligned (same as Npix132) |
| `Npix140.fits` | invalid FITS header | Non-block-aligned (same as Npix132) |
| `Npix4906.fits` | invalid FITS header | Non-block-aligned |
| `Npix691539.fits` | invalid FITS header | Non-block-aligned |
| `Npix8.fits` | invalid FITS header | Non-block-aligned: 527168 bytes (mod 2880 = 128) |
| `Npix9.fits` | invalid FITS header | Non-block-aligned |
| `allsky_panstarrs.fits` | invalid FITS header | Non-block-aligned: 6417216 bytes (mod 2880 = 576) |
| `Random_Groups.fits` | missing required keyword: NAXISn | Random groups format (NAXIS1=0, GROUPS=T) |
| `SN2923fxjA.fits` | missing required keyword: BITPIX | Comment separator `/No.` lacks leading space |
| `new_url.fits` | missing required keyword: BITPIX | Comment separator `/No.` lacks leading space |

### Failure Analysis

#### 1. Non-block-aligned files (10 files)

`header_byte_len()` requires `data.len().is_multiple_of(2880)` before attempting header parsing. Files whose total size isn't a multiple of 2880 are rejected even if the header and data content are valid.

All three reference implementations (cfitsio, rust-fitsio, fitsrs) also enforce 2880-byte block alignment. However, cfitsio and fitsrs calculate padding at each HDU boundary rather than checking the total remaining data length, so they can parse the first HDU even if the file is truncated. The Npix files appear to be HiPS tiles generated by Aladin/Hipsgen that omit trailing padding.

**Fix:** Check block alignment at each HDU boundary rather than on the total remaining data length. Allow the final HDU's data block to be truncated (no trailing padding).

#### 2. Comment separator without leading space (2 files)

`split_comment()` in `value.rs` only recognizes ` / ` (space-slash-space) as a comment separator. Real-world files from IDL and other tools write comments like `BITPIX = -32 /No. of bits per pixel` where the slash has no leading space. The value+comment text fails to parse as an integer.

Both cfitsio and fitsrs accept `/` without a leading space:
- **cfitsio** (`ffpsvc()`): Scans for `/` after the value, optionally skips a following space
- **fitsrs** (`split_value_and_comment()`): State machine treats any `/` outside quotes as a comment separator

**Fix:** Accept `/` as a comment separator regardless of leading whitespace.

#### 3. Random groups format (1 file)

Random groups (NAXIS1=0, GROUPS=T) is a legacy FITS format for interferometric visibility data. The parser fails because NAXIS1=0 triggers a missing-axis error.

cfitsio fully supports random groups with a special case: when NAXIS1=0 and GROUPS=T, it sets npix=1 and calculates data size as `(PCOUNT + 1) * |BITPIX/8| * GCOUNT`. fitsrs does not implement random groups at all.

**Fix:** Low priority â€” only needed by `marlu` (radio astronomy UVFITS). Detect GROUPS=T and handle NAXIS1=0 as a special flag.

## Identified Gaps and Issues

### 1. Tiled Image Compression
Files using FITS Tiled Image Compression (e.g., `comp.fits`) are stored as Binary Tables with specific keywords (`ZIMAGE`, `ZCMPTYPE`).
- **Current Behavior:** `fitsio-pure` identifies these as standard `BINTABLE` extensions.
- **Expected Behavior:** Ideally, the library should provide a way to transparently decompress these into `ImageData`.

### 2. Variable Length Array (VLA) Parsing
Binary tables using `P` or `Q` descriptors (e.g., `TFORM1 = '1PB'`) cause parsing errors in `read_binary_column`.
- **Root Cause:** `parse_tform_binary` in `bintable.rs` does not recognize the `P` or `Q` prefix.
- **Impact:** Any binary table with variable-length columns cannot be read.

### 3. Comment Separator Too Strict
`split_comment()` requires ` / ` but real-world files use `/` without a leading space. Both cfitsio and fitsrs are more lenient.

### 4. Block Alignment Too Strict
`header_byte_len()` checks the total remaining data length rather than per-HDU alignment. Files truncated after valid data are rejected.

## Recommendations

| Priority | Fix | Impact |
|----------|-----|--------|
| **High** | Relax comment separator to accept `/` without leading space | Fixes 2 real-world files, matches cfitsio/fitsrs behavior |
| **High** | Check block alignment per-HDU, allow truncated trailing padding | Fixes 10 real-world files from HiPS generators |
| **Medium** | Support `P`/`Q` TFORM descriptors for variable-length arrays | Enables heap-based binary table columns |
| **Low** | Tiled image compression awareness | Large effort, niche use case |
| **Low** | Random groups format (NAXIS1=0, GROUPS=T) | Legacy format, only needed by marlu |
